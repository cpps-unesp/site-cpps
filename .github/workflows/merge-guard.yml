name: Merge Guard

on:
  pull_request:

permissions:
  checks: read
  pull-requests: read

jobs:
  validate:
    if: github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for build to complete
        uses: actions/github-script@v7
        with:
          script: |
            const headSha = context.payload.pull_request.head.sha;
            const maxAttempts = 30;
            const delaySeconds = 10;
            
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              const { data } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: headSha,
                filter: 'latest',
                per_page: 100,
              });

              const buildCheck = data.check_runs.find((run) => run.name === 'build');
              
              if (!buildCheck) {
                core.info(`Attempt ${attempt}/${maxAttempts}: Build check not found yet, waiting...`);
                await new Promise(r => setTimeout(r, delaySeconds * 1000));
                continue;
              }

              if (buildCheck.status === 'completed') {
                if (buildCheck.conclusion === 'success') {
                  core.info('Build check passed!');
                  return;
                } else {
                  core.setFailed(`Build check failed with conclusion: ${buildCheck.conclusion}`);
                  return;
                }
              }

              core.info(`Attempt ${attempt}/${maxAttempts}: Build still running, waiting...`);
              await new Promise(r => setTimeout(r, delaySeconds * 1000));
            }
            
            core.setFailed('Timeout waiting for build check to complete.');
