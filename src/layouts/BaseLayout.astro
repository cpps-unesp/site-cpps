---
import { getTranslations, type Language } from '../utils/i18n';
import { getLangFromUrl } from '../utils/getLangFromUrl';
import { getLocalizedPathFromPathname, isSupportedLang } from '../utils/i18nRouteMatch';

const urlLang = getLangFromUrl(Astro.url) as Language;

interface Props {
  titulo?: string;
  descricao?: string;
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  texts?: any;
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  identidade?: any;
  lang?: Language;
  githubPath?: string;
}

const { lang: propLang, texts, identidade, githubPath, titulo, descricao } = Astro.props as Props;

const lang = propLang ?? urlLang;
const t = getTranslations(lang);
const pageTexts = texts ?? t.texts;
const pageIdentidade = identidade ?? t.identidade;
const pageTitle = titulo ?? t.titulo;
const pageDescription = descricao ?? t.descricao;

const pathname = Astro.url.pathname;
const canonicalUrl = new URL(pathname || `/${lang}/`, Astro.site).toString();
const pathParts = pathname.split('/').filter(Boolean);
const hasLangInPath = isSupportedLang(pathParts[0] ?? '');
const isLangHome = hasLangInPath && pathParts.length === 1;
const alternateHrefs = (['pt', 'en', 'es'] as Language[]).map((targetLang) => {
  const localizedPath = hasLangInPath
    ? getLocalizedPathFromPathname(pathname, targetLang)
    : `/${targetLang}/`;

  return {
    lang: targetLang,
    href: new URL(localizedPath, Astro.site).toString(),
  };
});

const ogLocale = lang === 'pt' ? 'pt_BR' : lang === 'en' ? 'en_US' : 'es_ES';
const ogAlternateLocales = alternateHrefs
  .map(({ lang: localeLang }) =>
    localeLang === 'pt' ? 'pt_BR' : localeLang === 'en' ? 'en_US' : 'es_ES'
  )
  .filter((locale) => locale !== ogLocale);

import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import GitHubEditLink from '../components/GitHubEditLink.astro';
import SearchModal from '../components/SearchModal.astro';
import BackToTop from '../components/BackToTop.astro';

import '../styles/global.css';
---

<html lang={lang} dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{pageTitle}</title>
    <link rel="icon" href="/imagens/logos/cpps/favicon.ico" />
    <meta name="description" content={pageDescription} />
    <meta name="robots" content="index, follow" />

    <!-- ✅ Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:locale" content={ogLocale} />
    {ogAlternateLocales.map((locale) => <meta property="og:locale:alternate" content={locale} />)}
    <meta
      property="og:image"
      content="https://cpps.franca.unesp.br/imagens/logos/cpps/logo-cpps-01_rev_1.png"
    />
    <meta property="og:image:alt" content="Logotipo do CPPS - UNESP" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <!-- ✅ SEO multilíngue -->
    {
      alternateHrefs.map(({ lang: altLang, href }) => (
        <link rel="alternate" hreflang={altLang} href={href} />
      ))
    }
    <link rel="alternate" hreflang="x-default" href={alternateHrefs[0].href} />

    <!-- ✅ canonical -->
    <link rel="canonical" href={canonicalUrl} />

    <!-- ✅ Performance com fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <script is:inline>
      (function () {
        const THEME_STORAGE_KEY = 'theme';
        const DEFAULT_THEME_CHOICE = 'system';
        const storedChoice = localStorage.getItem(THEME_STORAGE_KEY) || DEFAULT_THEME_CHOICE;
        let themeToApply = storedChoice;
        if (storedChoice === 'system') {
          themeToApply = window.matchMedia('(prefers-color-scheme: dark)').matches
            ? 'dark'
            : 'light';
        }
        document.documentElement.setAttribute('data-theme', themeToApply);
      })();
    </script>
  </head>

  <body class="bg-base-100 text-base-content">
    <Header lang={lang} texts={pageTexts} identidade={pageIdentidade} />

    <main class:list={[isLangHome ? 'pt-0' : 'pt-20 md:pt-24', 'flex-1']} data-pagefind-body>
      <slot />
      {
        githubPath && (
          <div class="mx-auto max-w-screen-2xl px-4 md:px-8">
            <GitHubEditLink githubPath={githubPath} lang={lang} texts={pageTexts} />
          </div>
        )
      }
    </main>
    <Footer lang={lang} texts={pageTexts} githubPath={githubPath} />
    <BackToTop lang={lang} />
    <SearchModal texts={pageTexts} />
    <script type="module" src="/scripts/themeSwitcher.js"></script>
  </body>
</html>
