---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import NoticiasSection from '../../../../components/NoticiasSection.astro';
import { getCollection } from 'astro:content';
import slugify from "slugify";
import { getTranslations } from '../../../../utils/i18n';
import type { SupportedLang } from '../../../../types/lang';

export async function getStaticPaths() {
  const langs = ["pt", "en", "es"];
  const allNoticias = await getCollection('noticias');

  return langs.flatMap((lang) => {
    const langNoticias = allNoticias.filter(post => post.data.lang === lang);
    const allTags = langNoticias.flatMap(post => post.data.tags || []);
    const uniqueTags = Array.from(new Set(allTags));

    return uniqueTags.map(tag => ({
      params: {
        lang,
        tag: slugify(tag, { lower: true, strict: true }),
      }
    }));
  });
}

const currentLang = (Astro.params.lang ?? "pt") as SupportedLang;
const currentTag = Astro.params.tag;
const locale = getTranslations(currentLang);

const allNoticias = await getCollection('noticias');

const noticias = allNoticias.filter(post => 
  post.data.lang === currentLang &&
  post.data.tags?.some(tag => 
    slugify(tag, { lower: true, strict: true }) === currentTag
  )
);
---

<BaseLayout lang={currentLang} titulo={`${locale.texts.header.noticias}: ${currentTag}`} descricao={locale.descricao} texts={locale.texts}>
  <NoticiasSection noticias={noticias} lang={currentLang} />
</BaseLayout>
