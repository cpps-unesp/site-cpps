---
export const prerender = true;

import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import routeTranslations from "../../i18n/routeTranslations";
import { getTranslations } from "../../utils/i18n";

export function getStaticPaths() {
  return [
    { params: { lang: "pt" } },
    { params: { lang: "en" } },
    { params: { lang: "es" } },
  ];
}

const { lang = "pt" } = Astro.params;
const locale = getTranslations(lang as any);
const { texts } = locale;

// Carregar coleções
const allNoticias = await getCollection("noticias");
const allPublicacoes = await getCollection("publicacoes");
const allMembros = await getCollection("membros");
const allAtividades = await getCollection("atividades");

const langs = ["pt", "en", "es"];

function getStatusColor(coverage: number) {
  if (coverage === 100) return "badge-success";
  if (coverage > 0) return "badge-warning";
  return "badge-ghost";
}

function getStatusLabel(coverage: number) {
  if (coverage === 100) return lang === 'en' ? 'Complete' : (lang === 'es' ? 'Completo' : 'Completo');
  if (coverage > 0) return lang === 'en' ? 'Partial' : (lang === 'es' ? 'Parcial' : 'Parcial');
  return lang === 'en' ? 'Missing' : (lang === 'es' ? 'Faltando' : 'Faltando');
}

// 1. Processar Páginas Institucionais (routeTranslations)
const institutionalPages = Object.entries(routeTranslations).map(([key, trans]) => {
  const coverage = langs.filter(l => !!trans[l as keyof typeof trans]).length;
  return {
    key,
    coverage: (coverage / langs.length) * 100,
    pt: !!trans.pt,
    en: !!trans.en,
    es: !!trans.es
  };
});

// 2. Processar Notícias
const noticiaGroups = new Map();
allNoticias.forEach(n => {
  if (!noticiaGroups.has(n.slug)) noticiaGroups.set(n.slug, new Set());
  noticiaGroups.get(n.slug).add(n.data.lang);
});

const noticiasReport = Array.from(noticiaGroups.entries()).map(([slug, available]) => {
  return {
    slug,
    coverage: (available.size / langs.length) * 100,
    pt: available.has('pt'),
    en: available.has('en'),
    es: available.has('es')
  };
});

// 3. Processar Publicações
const pubGroups = new Map();
allPublicacoes.forEach(p => {
    // Publicações podem ter slug ou id
    const s = p.slug || p.id.replace(/\.[^/.]+$/, "");
    if (!pubGroups.has(s)) pubGroups.set(s, new Set());
    pubGroups.get(s).add(p.data.lang);
});

const publicacoesReport = Array.from(pubGroups.entries()).map(([slug, available]) => {
  return {
    slug,
    coverage: (available.size / langs.length) * 100,
    pt: available.has('pt'),
    en: available.has('en'),
    es: available.has('es')
  };
});

// 4. Processar Membros
const membroGroups = new Map();
allMembros.forEach(m => {
    const fileName = m.id.split("/").pop() ?? "";
    const s = fileName.replace(/\.(pt|en|es)\.mdx$/, "");
    if (!membroGroups.has(s)) membroGroups.set(s, new Set());
    membroGroups.get(s).add(m.data.lang);
});

const membrosReport = Array.from(membroGroups.entries()).map(([slug, available]) => {
  return {
    slug,
    coverage: (available.size / langs.length) * 100,
    pt: available.has('pt'),
    en: available.has('en'),
    es: available.has('es')
  };
});
---

<BaseLayout lang={lang} titulo="Relatório de Cobertura de Idiomas" texts={texts}>
  <div class="max-w-screen-xl mx-auto px-4 md:px-8 py-16">
    <header class="mb-12">
      <h1 class="text-5xl font-black mb-4 uppercase tracking-tighter">Cobertura de Idiomas</h1>
      <p class="text-xl text-base-content/60">Status de tradução de todas as páginas e conteúdos do site.</p>
    </header>

    <div class="space-y-16">
      <!-- Seção: Páginas Institucionais -->
      <section>
        <h2 class="text-3xl font-bold mb-8 flex items-center gap-3">
          <i class="fa-solid fa-layer-group text-primary"></i>
          Páginas Institucionais e Iniciativas
        </h2>
        <div class="overflow-x-auto bg-base-200 rounded-3xl border border-base-300">
          <table class="table table-zebra w-full">
            <thead>
              <tr class="text-xs uppercase tracking-widest opacity-50">
                <th class="py-6 pl-8">Página</th>
                <th class="text-center">PT</th>
                <th class="text-center">EN</th>
                <th class="text-center">ES</th>
                <th class="pr-8 text-right">Status</th>
              </tr>
            </thead>
            <tbody>
              {institutionalPages.map(page => (
                <tr class="hover:bg-base-300/50 transition-colors">
                  <td class="font-bold py-4 pl-8">{page.key}</td>
                  <td class="text-center">{page.pt ? '✅' : '❌'}</td>
                  <td class="text-center">{page.en ? '✅' : '❌'}</td>
                  <td class="text-center">{page.es ? '✅' : '❌'}</td>
                  <td class="pr-8 text-right">
                    <span class={`badge ${getStatusColor(page.coverage)} badge-sm font-bold uppercase py-3 px-4`}>
                      {getStatusLabel(page.coverage)}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </section>

      <!-- Seção: Membros -->
      <section>
        <h2 class="text-3xl font-bold mb-8 flex items-center gap-3">
          <i class="fa-solid fa-users text-primary"></i>
          Equipe (Páginas Individuais)
        </h2>
        <div class="overflow-x-auto bg-base-200 rounded-3xl border border-base-300">
          <table class="table table-zebra w-full">
            <thead>
              <tr class="text-xs uppercase tracking-widest opacity-50">
                <th class="py-6 pl-8">Membro</th>
                <th class="text-center">PT</th>
                <th class="text-center">EN</th>
                <th class="text-center">ES</th>
                <th class="pr-8 text-right">Status</th>
              </tr>
            </thead>
            <tbody>
              {membrosReport.map(item => (
                <tr class="hover:bg-base-300/50 transition-colors">
                  <td class="font-bold py-4 pl-8">{item.slug}</td>
                  <td class="text-center">{item.pt ? '✅' : '❌'}</td>
                  <td class="text-center">{item.en ? '✅' : '❌'}</td>
                  <td class="text-center">{item.es ? '✅' : '❌'}</td>
                  <td class="pr-8 text-right">
                    <span class={`badge ${getStatusColor(item.coverage)} badge-sm font-bold uppercase py-3 px-4`}>
                      {getStatusLabel(item.coverage)}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </section>

      <!-- Seção: Notícias -->
      <section>
        <h2 class="text-3xl font-bold mb-8 flex items-center gap-3">
          <i class="fa-solid fa-newspaper text-primary"></i>
          Notícias
        </h2>
        <div class="overflow-x-auto bg-base-200 rounded-3xl border border-base-300">
          <table class="table table-zebra w-full">
            <thead>
              <tr class="text-xs uppercase tracking-widest opacity-50">
                <th class="py-6 pl-8">Slug</th>
                <th class="text-center">PT</th>
                <th class="text-center">EN</th>
                <th class="text-center">ES</th>
                <th class="pr-8 text-right">Status</th>
              </tr>
            </thead>
            <tbody>
              {noticiasReport.map(item => (
                <tr class="hover:bg-base-300/50 transition-colors">
                  <td class="font-bold py-4 pl-8 text-xs">{item.slug}</td>
                  <td class="text-center">{item.pt ? '✅' : '❌'}</td>
                  <td class="text-center">{item.en ? '✅' : '❌'}</td>
                  <td class="text-center">{item.es ? '✅' : '❌'}</td>
                  <td class="pr-8 text-right">
                    <span class={`badge ${getStatusColor(item.coverage)} badge-sm font-bold uppercase py-3 px-4`}>
                      {getStatusLabel(item.coverage)}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </section>

       <!-- Seção: Publicações -->
       <section>
        <h2 class="text-3xl font-bold mb-8 flex items-center gap-3">
          <i class="fa-solid fa-book text-primary"></i>
          Publicações
        </h2>
        <div class="overflow-x-auto bg-base-200 rounded-3xl border border-base-300">
          <table class="table table-zebra w-full">
            <thead>
              <tr class="text-xs uppercase tracking-widest opacity-50">
                <th class="py-6 pl-8">Identificador</th>
                <th class="text-center">PT</th>
                <th class="text-center">EN</th>
                <th class="text-center">ES</th>
                <th class="pr-8 text-right">Status</th>
              </tr>
            </thead>
            <tbody>
              {publicacoesReport.map(item => (
                <tr class="hover:bg-base-300/50 transition-colors">
                  <td class="font-bold py-4 pl-8 text-xs">{item.slug}</td>
                  <td class="text-center">{item.pt ? '✅' : '❌'}</td>
                  <td class="text-center">{item.en ? '✅' : '❌'}</td>
                  <td class="text-center">{item.es ? '✅' : '❌'}</td>
                  <td class="pr-8 text-right">
                    <span class={`badge ${getStatusColor(item.coverage)} badge-sm font-bold uppercase py-3 px-4`}>
                      {getStatusLabel(item.coverage)}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </div>
</BaseLayout>

<style>
  h1, h2 {
    font-family: 'Montserrat', sans-serif;
  }
</style>
