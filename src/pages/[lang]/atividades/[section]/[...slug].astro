---
export const prerender = false;

import { getCollection } from 'astro:content';
import type { SupportedLang } from '../../../../types/lang';
import { resolveAtividadesLegacyPath } from '../../../../utils/atividadesLegacyRedirect';
import { filterVisibleDocsEntries } from '../../../../utils/docsVisibility';

const lang = (Astro.params.lang ?? 'pt') as SupportedLang;
const section = Astro.params.section ?? '';
const slugParts = Astro.params.slug;
const tail = Array.isArray(slugParts) ? slugParts.join('/') : (slugParts ?? '');
const fullSlug = tail ? `${section}/${tail}` : section;

const entries = filterVisibleDocsEntries(await getCollection('atividades'));
const validSlugs = new Set(entries.map((entry) => entry.slug));
const redirectPath = resolveAtividadesLegacyPath(lang, fullSlug, validSlugs);

if (redirectPath) {
  return Astro.redirect(redirectPath, 301);
}

return Astro.redirect(`/${lang}/atividades`, 302);
---
