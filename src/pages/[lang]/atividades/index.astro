---
export const prerender = true;
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import LinkCard from '../../../components/atividades/LinkCard.astro';
import CardGrid from '../../../components/atividades/CardGrid.astro';
import Notice from '../../../components/atividades/Notice.astro';
import type { Language } from '../../../utils/i18n';
import { buildAtividadesSidebar } from '../../../utils/atividadesSidebar';
import type { SidebarItem } from '../../../config/atividades';

export function getStaticPaths() {
  return [
    { params: { lang: "pt" } },
    { params: { lang: "en" } },
    { params: { lang: "es" } },
  ];
}

const lang = (Astro.params.lang ?? 'pt') as Language;
const basePath = `/${lang}/atividades`;

const atividades = await getCollection('atividades');
const sidebar = buildAtividadesSidebar(atividades);

function normalizeAtividadesUrl(path: string): string {
  const normalized = path.replace(/\/+$/, '');
  return normalized.endsWith('/index') ? normalized.slice(0, -6) : normalized;
}

function flattenSidebarUrls(items: SidebarItem[]): string[] {
  return items.flatMap((item) => {
    const current = item.url && item.url.startsWith('/atividades') ? [normalizeAtividadesUrl(item.url)] : [];
    const nested = item.items ? flattenSidebarUrls(item.items) : [];
    return [...current, ...nested];
  });
}

const sidebarUrls = new Set(flattenSidebarUrls(sidebar));

const orphanActivityPages = atividades
  .map((entry) => {
    const routePath = normalizeAtividadesUrl(`/atividades/${entry.slug}`);
    return {
      routePath,
      title: entry.data.title || entry.slug,
    };
  })
  .filter((entry) => !sidebarUrls.has(entry.routePath))
  .sort((a, b) => a.routePath.localeCompare(b.routePath, 'pt-BR'));
---

<BaseLayout
  titulo="Atividades"
  descricao="Explore atividades, materiais e documentacoes do CPPS."
  githubPath="src/pages/[lang]/atividades/index.astro"
  lang={lang}
>
  <div class="max-w-screen-xl mx-auto px-4 md:px-8 pt-8 pb-16 md:pt-12">
    <header class="mb-12 md:mb-14 text-center max-w-3xl mx-auto">
        <span class="text-primary font-bold tracking-widest uppercase text-sm mb-4 block">Central de Atividades</span>
        <h1 class="titulo mb-5 font-black">Atividades CPPS</h1>
        <p class="subtitulo text-base-content/70 mx-auto">
            Explore nossos materiais, trilhas de ensino e documentacoes de projetos.
        </p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
        <section class="lg:col-span-2 space-y-12">
            <div>
                <h2 class="mini-titulo mb-6 flex items-center gap-3">
                    <i class="fa-solid fa-star text-primary text-2xl"></i>
                    Essencial
                </h2>
                <CardGrid columns={2}>
                    <LinkCard
                        title="Guia de Edicao"
                        href={`${basePath}/guia-edicao`}
                        description="Aprenda a criar e editar paginas usando Markdown e componentes."
                        icon="âœï¸"
                    />
                    <LinkCard
                        title="Trilha de Dados"
                        href={`${basePath}/projetos/ensino/tfdt`}
                        description="Nossa trilha completa de fundamentos de tecnologia."
                        icon="ðŸ"
                    />
                </CardGrid>
            </div>

            <div>
                <h2 class="mini-titulo mb-6 flex items-center gap-3">
                    <i class="fa-solid fa-microchip text-primary text-2xl"></i>
                    Sistemas e Dados
                </h2>
                <CardGrid columns={2}>
                    <LinkCard
                        title="Acervos de Dados"
                        href={`${basePath}/projetos/dados`}
                        description="Documentacao tecnica sobre a Hemeroteca e NewsCloud."
                        icon="ðŸ“Š"
                    />
                    <LinkCard
                        title="Infraestrutura"
                        href={`${basePath}/projetos/sistemas/infraestrutura`}
                        description="Configuracoes de servidores, redes e automacao."
                        icon="âš™ï¸"
                    />
                </CardGrid>
            </div>

            <Notice type="info" title="Interface Renovada">
                Agora voce pode colapsar as barras laterais clicando nas setas para focar totalmente na leitura.
            </Notice>

            <section class="rounded-3xl border border-base-300 bg-base-100 shadow-sm">
                <div class="p-6 md:p-8">
                    <h2 class="mini-titulo mb-3">Paginas de atividades fora do menu</h2>
                    {orphanActivityPages.length > 0 ? (
                        <>
                            <p class="text-base-content/70 mb-4">
                                Encontramos {orphanActivityPages.length} paginas que existem no conteudo, mas ainda nao aparecem no menu lateral.
                            </p>
                            <details class="collapse collapse-plus border border-base-300 bg-base-200/40">
                                <summary class="collapse-title font-semibold">Ver lista completa</summary>
                                <div class="collapse-content">
                                    <ul class="columns-1 sm:columns-2 gap-6 space-y-2 text-sm">
                                        {orphanActivityPages.map((page) => (
                                            <li class="break-inside-avoid">
                                                <a
                                                    href={`/${lang}${page.routePath}`}
                                                    class="link link-hover text-primary"
                                                    title={page.routePath}
                                                >
                                                    {page.title}
                                                </a>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            </details>
                        </>
                    ) : (
                        <p class="text-success font-medium">
                            Todas as paginas de atividades ja estao representadas no menu lateral.
                        </p>
                    )}
                </div>
            </section>
        </section>

        <aside class="space-y-8">
            <div class="bg-base-200 rounded-3xl p-8 border border-base-300">
                <h3 class="font-bold text-xl mb-4 italic text-primary">Navegacao Rapida</h3>
                <ul class="menu menu-compact bg-transparent p-0">
                    <li><a href={`${basePath}/projetos/dados/hemeroteca-peb`} class="py-2">Hemeroteca PEB</a></li>
                    <li><a href={`${basePath}/projetos/sistemas/websites/01-intro-md`} class="py-2">Edicao de Websites</a></li>
                    <li><a href={`${basePath}/projetos/sistemas/infraestrutura/linux/atualizar`} class="py-2">Servidores Linux</a></li>
                </ul>
            </div>

            <div class="bg-primary/5 rounded-3xl p-8 border border-primary/20">
                <h3 class="font-bold text-xl mb-4 text-primary">Repositorio Org</h3>
                <p class="text-sm mb-4 opacity-80 italic">Contribua com codigo e documentacao no nosso GitHub oficial.</p>
                <a href="https://github.com/cpps-unesp" target="_blank" class="btn btn-primary btn-block">
                    <i class="fa-brands fa-github mr-2"></i>
                    Acessar GitHub
                </a>
            </div>
        </aside>
    </div>
  </div>
</BaseLayout>
