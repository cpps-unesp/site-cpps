---
export const prerender = true;
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import LinkCard from '../../../components/atividades/LinkCard.astro';
import CardGrid from '../../../components/atividades/CardGrid.astro';
import Notice from '../../../components/atividades/Notice.astro';
import type { Language } from '../../../utils/i18n';
import { buildAtividadesSidebarWithBase } from '../../../utils/atividadesSidebar';
import { filterVisibleDocsEntries } from '../../../utils/docsVisibility';
import type { SidebarItem } from '../../../types/docs';

export function getStaticPaths() {
  return [{ params: { lang: 'pt' } }, { params: { lang: 'en' } }, { params: { lang: 'es' } }];
}

const lang = (Astro.params.lang ?? 'pt') as Language;
const wikiBasePath = `/${lang}/wiki`;

const atividades = filterVisibleDocsEntries(await getCollection('atividades'));
const sidebar = buildAtividadesSidebarWithBase(atividades, '/wiki');

function normalizeWikiUrl(path: string): string {
  const normalized = path.replace(/\/+$/, '');
  return normalized.endsWith('/index') ? normalized.slice(0, -6) : normalized;
}

function flattenSidebarUrls(items: SidebarItem[]): string[] {
  return items.flatMap((item) => {
    const current = item.url && item.url.startsWith('/wiki') ? [normalizeWikiUrl(item.url)] : [];
    const nested = item.items ? flattenSidebarUrls(item.items) : [];
    return [...current, ...nested];
  });
}

const sidebarUrls = new Set(flattenSidebarUrls(sidebar));

const orphanActivityPages = atividades
  .map((entry) => {
    const routePath = normalizeWikiUrl(`/wiki/${entry.slug}`);
    return {
      routePath,
      title: entry.data.title || entry.slug,
    };
  })
  .filter((entry) => !sidebarUrls.has(entry.routePath))
  .sort((a, b) => a.routePath.localeCompare(b.routePath, 'pt-BR'));
---

<BaseLayout
  titulo="Atividades"
  descricao="Explore atividades, materiais e documentacoes do CPPS."
  githubPath="src/pages/[lang]/atividades/index.astro"
  lang={lang}
>
  <div class="mx-auto max-w-screen-xl px-4 pt-8 pb-16 md:px-8 md:pt-12">
    <header class="mx-auto mb-12 max-w-3xl text-center md:mb-14">
      <span class="text-primary mb-4 block text-sm font-bold tracking-widest uppercase"
        >Central de Atividades</span
      >
      <h1 class="titulo mb-5 font-black">Atividades CPPS</h1>
      <p class="subtitulo text-base-content/70 mx-auto">
        Explore nossos materiais, trilhas de ensino e documentacoes de projetos.
      </p>
    </header>

    <div class="grid grid-cols-1 gap-12 lg:grid-cols-3">
      <section class="space-y-12 lg:col-span-2">
        <div>
          <h2 class="mini-titulo mb-6 flex items-center gap-3">
            <i class="fa-solid fa-star text-primary text-2xl"></i>
            Essencial
          </h2>
          <CardGrid columns={2}>
            <LinkCard
              title="Guia de Edicao"
              href={`/${lang}/editar-site`}
              description="Aprenda a criar e editar paginas usando Markdown e componentes."
              icon="âœï¸"
            />
            <LinkCard
              title="Trilha de Dados"
              href={`${wikiBasePath}/projetos/ensino/tfdt`}
              description="Nossa trilha completa de fundamentos de tecnologia."
              icon="ðŸ"
            />
          </CardGrid>
        </div>

        <div>
          <h2 class="mini-titulo mb-6 flex items-center gap-3">
            <i class="fa-solid fa-microchip text-primary text-2xl"></i>
            Wiki de Projetos
          </h2>
          <CardGrid columns={3}>
            <LinkCard
              title="Projetos de Dados"
              href={`${wikiBasePath}/projetos/dados`}
              description="Acesse acervos, documentaÃ§Ã£o tÃ©cnica e bases de pesquisa."
              icon="ðŸ“Š"
            />
            <LinkCard
              title="Projetos de Ensino"
              href={`${wikiBasePath}/projetos/ensino`}
              description="Trilhas, cursos, materiais de apoio e conteÃºdos formativos."
              icon="ðŸŽ“"
            />
            <LinkCard
              title="Projetos de Sistemas"
              href={`${wikiBasePath}/projetos/sistemas`}
              description="Infraestrutura, websites, redes, automaÃ§Ã£o e operaÃ§Ã£o tÃ©cnica."
              icon="âš™ï¸"
            />
          </CardGrid>
        </div>

        <Notice type="info" title="Interface Renovada">
          Agora voce pode colapsar as barras laterais clicando nas setas para focar totalmente na
          leitura.
        </Notice>

        <section class="border-base-300 bg-base-100 rounded-3xl border shadow-sm">
          <div class="p-6 md:p-8">
            <h2 class="mini-titulo mb-3">Paginas de atividades fora do menu</h2>
            {
              orphanActivityPages.length > 0 ? (
                <>
                  <p class="text-base-content/70 mb-4">
                    Encontramos {orphanActivityPages.length} paginas que existem no conteudo, mas
                    ainda nao aparecem no menu lateral.
                  </p>
                  <details class="collapse-plus border-base-300 bg-base-200/40 collapse border">
                    <summary class="collapse-title font-semibold">Ver lista completa</summary>
                    <div class="collapse-content">
                      <ul class="columns-1 gap-6 space-y-2 text-sm sm:columns-2">
                        {orphanActivityPages.map((page) => (
                          <li class="break-inside-avoid">
                            <a
                              href={`/${lang}${page.routePath}`}
                              class="link link-hover text-primary"
                              title={page.routePath}
                            >
                              {page.title}
                            </a>
                          </li>
                        ))}
                      </ul>
                    </div>
                  </details>
                </>
              ) : (
                <p class="text-success font-medium">
                  Todas as paginas de atividades ja estao representadas no menu lateral.
                </p>
              )
            }
          </div>
        </section>
      </section>

      <aside class="space-y-8">
        <div class="bg-base-200 border-base-300 rounded-3xl border p-8">
          <h3 class="text-primary mb-4 text-xl font-bold italic">Navegacao Rapida</h3>
          <ul class="menu menu-compact bg-transparent p-0">
            <li>
              <a href={`${wikiBasePath}/projetos/dados/hemeroteca-peb`} class="py-2">Hemeroteca PEB</a>
            </li>
            <li>
              <a href={`${wikiBasePath}/projetos/sistemas/websites/01-intro-md`} class="py-2"
                >Edicao de Websites</a
              >
            </li>
            <li>
              <a href={`${wikiBasePath}/projetos/sistemas/infraestrutura/linux/atualizar`} class="py-2"
                >Servidores Linux</a
              >
            </li>
          </ul>
        </div>

        <div class="bg-primary/5 border-primary/20 rounded-3xl border p-8">
          <h3 class="text-primary mb-4 text-xl font-bold">Repositorio Org</h3>
          <p class="mb-4 text-sm italic opacity-80">
            Contribua com codigo e documentacao no nosso GitHub oficial.
          </p>
          <a href="https://github.com/cpps-unesp" target="_blank" class="btn btn-primary btn-block">
            <i class="fa-brands fa-github mr-2"></i>
            Acessar GitHub
          </a>
        </div>
      </aside>
    </div>
  </div>
</BaseLayout>
