---
export const prerender = false;

import { getCollection } from 'astro:content';
import type { SupportedLang } from '../../../types/lang';
import routeTranslations from '../../../i18n/routeTranslations';
import { normalizeLegacyAtividadesSlug } from '../../../utils/wikiLegacyAliases';

const lang = (Astro.params.lang ?? 'pt') as SupportedLang;
const slugParam = Astro.params.slug;
const slugPath = Array.isArray(slugParam) ? slugParam.join('/') : (slugParam ?? '');

if (!slugPath) {
  return new Response(null, { status: 404 });
}

const normalizedSlug = normalizeLegacyAtividadesSlug(slugPath);

if (normalizedSlug) {
  if (normalizedSlug === 'equipe') {
    return Astro.redirect(`/${lang}/${routeTranslations['institucional/equipe'][lang]}`, 301);
  }

  const entries = await getCollection('atividades');
  const validSlugs = new Set(entries.map((entry) => entry.slug));

  if (validSlugs.has(normalizedSlug)) {
    const suffix = normalizedSlug === 'index' ? '' : `/${normalizedSlug}`;
    return Astro.redirect(`/${lang}/wiki${suffix}`, 301);
  }
}

return Astro.redirect(`/${lang}/atividades`, 302);
---
