---
export const prerender = true;

import BaseLayout from "../../layouts/BaseLayout.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import EquipeSection from "../../components/EquipeSection.astro";
import SobreSection from "../../components/BlocoSection.astro";
import ProjetosSection from "../../components/ProjetosSection.astro";
import CafeComCienciaSection from "../../components/CafeComCienciaSection.astro";
import DocumentosSection from "../../components/DocumentosSection.astro";

import IniciativasPublicacoesSection from "../../components/IniciativasPublicacoesSection.astro";
import IniciativasMaterialApoioSection from "../../components/IniciativasMaterialApoioSection.astro";
import IniciativasOficinasSection from "../../components/IniciativasOficinasSection.astro";
import IniciativasParceiriasSection from "../../components/IniciativasParceiriasSection.astro";
import IniciativasSolucoesTecnologicasSection from "../../components/IniciativasSolucoesTecnologicasSection.astro";
import IniciativasProjetosSection from "../../components/IniciativasProjetosSection.astro";
import IniciativasProjetosDeDadosSection from "../../components/IniciativasProjetosDeDadosSection.astro";
import IniciativasProjetosDePesquisaSection from "../../components/IniciativasProjetosDePesquisaSection.astro";

import NoticiaPage from "../../components/NoticiaPage.astro";
import NoticiasListPage from "../../components/NoticiasListPage.astro";
import PublicationListPage from "../../components/PublicationListPage.astro";
import PublicationPage from "../../components/PublicationPage.astro";
import routeTranslations from "../../i18n/routeTranslations";
import { getCollection } from "astro:content";
import type { SupportedLang } from "../../types/lang";
import { getTranslations } from "../../utils/i18n";
import slugify from "slugify";

// ✅ Exporta os caminhos possíveis para páginas estáticas
export async function getStaticPaths() {
  const langs: SupportedLang[] = ["pt", "en", "es"];
  const paths = [];

  // Páginas institucionais e outras do routeTranslations
  for (const [key, traducoes] of Object.entries(routeTranslations)) {
    for (const lang of langs) {
      const slugValue = traducoes[lang];
      if (typeof slugValue === "string") {
        paths.push({
          params: {
            lang,
            slug: slugValue,
          },
        });
      }
    }
  }

  // Notícias individuais
  const allNoticias = await getCollection("noticias");
  for (const noticia of allNoticias) {
    const lang = noticia.data.lang as SupportedLang;
    const prefix = routeTranslations["noticias"][lang];
    paths.push({
      params: {
        lang,
        slug: `${prefix}/${noticia.slug}`,
      },
    });
  }

  // Publicações individuais
  const allPublicacoes = await getCollection("publicacoes");
  for (const pub of allPublicacoes) {
    const lang = pub.data.lang as SupportedLang;
    const prefix = routeTranslations["publicacao"][lang];
    const slugValue = pub.slug || pub.id.replace(/\.[^/.]+$/, "");
    paths.push({
      params: {
        lang,
        slug: `${prefix}/${slugValue}`,
      },
    });
  }

  // Categorias de notícias
  const tags = [...new Set(allNoticias.flatMap(n => n.data.tags || []))];
  for (const lang of langs) {
    const prefix = routeTranslations["noticias"][lang];
    for (const tag of tags) {
      const tagSlug = slugify(tag, { lower: true, strict: true });
      paths.push({
        params: {
          lang,
          slug: `${prefix}/categoria/${tagSlug}`,
        },
      });
    }
  }

  // Membros
  const allMembros = await getCollection("membros");
  for (const membro of allMembros) {
    const fileName = membro.id.split("/").pop() ?? "";
    const slugWithoutLang = fileName.replace(/\.(pt|en|es)\.mdx$/, "");
    paths.push({
      params: {
        lang: membro.data.lang,
        slug: slugWithoutLang,
      },
    });
  }

  return paths;
}

// ✅ Lógica de roteamento e carregamento
const langs: SupportedLang[] = ["pt", "en", "es"];
const currentLang = (Astro.params.lang as SupportedLang) ?? "pt";
const slugParam = Astro.params.slug;
const slugPath = Array.isArray(slugParam)
  ? slugParam.join("/")
  : (slugParam ?? "");
const slugArray = slugPath.split("/");

const locale = getTranslations(currentLang);
const { titulo, descricao, texts, equipe, sobre, iniciativas, cafe, documentos } = locale;

const noticiasPrefix = routeTranslations["noticias"][currentLang];
const isNoticiasList = slugPath === noticiasPrefix;
const isNoticiasCategory = slugPath.startsWith(`${noticiasPrefix}/categoria/`);
const isNoticia = slugPath.startsWith(`${noticiasPrefix}/`) && !isNoticiasList && !isNoticiasCategory;

const publicacoesPrefix = routeTranslations["publicacao"][currentLang];
const isPublication = slugPath.startsWith(`${publicacoesPrefix}/`);

const allMembros = await getCollection("membros");
function getSlugFromEntry(entry: any) {
  const fileName = entry.id.split("/").pop() ?? "";
  return fileName.replace(/\.(pt|en|es)\.mdx$/, "");
}

let membroSelecionado = allMembros.find(
  (entry) =>
    getSlugFromEntry(entry) === slugPath && entry.data.lang === currentLang,
);

if (!membroSelecionado) {
  membroSelecionado = allMembros.find(
    (entry) => getSlugFromEntry(entry) === slugPath,
  );
}

// Renderiza o conteúdo do .mdx
let Content = null;
if (membroSelecionado) {
  const renderResult = await membroSelecionado.render();
  Content = renderResult.Content;
}

function findOriginalKey(
  translatedSlug: string,
  lang: SupportedLang,
): string | null {
  for (const [key, translations] of Object.entries(routeTranslations)) {
    if (translations[lang] === translatedSlug) {
      return key;
    }
  }
  return null;
}

const originalKey = findOriginalKey(slugPath, currentLang);
---

{
  isNoticiasList || isNoticiasCategory ? (
    <NoticiasListPage lang={currentLang} tag={isNoticiasCategory ? slugPath.split('/').pop() : undefined} />
  ) : isNoticia ? (
    <NoticiaPage lang={currentLang} slug={slugPath} />
  ) : isPublication ? (
    <PublicationPage lang={currentLang} slug={slugPath.replace(`${publicacoesPrefix}/`, '')} />
  ) : membroSelecionado ? (
    <BaseLayout
      lang={currentLang}
      titulo={membroSelecionado.data.title}
      descricao={membroSelecionado.data.cargo ?? ""}
      texts={texts}
      githubPath={`src/content/membros/${membroSelecionado.id}`}
    >
      <article class="max-w-3xl mx-auto pt-16 pb-10 text-center">
        <img
          src={membroSelecionado.data.foto}
          alt={membroSelecionado.data.title}
          class="w-48 h-48 object-cover rounded-xl mx-auto mb-4"
        />
        <h1 class="text-3xl font-bold text-primary">
          {membroSelecionado.data.title}
        </h1>
        <p class="text-neutral text-sm mb-8">{membroSelecionado.data.cargo}</p>

        {Content ? (
          <div class="mt-16 prose prose-lg prose-p:my-6 mx-auto text-justify leading-relaxed">
            <Content />
          </div>
        ) : (
          <p class="text-warning mt-4">
            {texts.languageUnavailable ??
              "Conteúdo do membro indisponível neste idioma."}
          </p>
        )}
      </article>
    </BaseLayout>
  ) : (
    <BaseLayout
      lang={currentLang}
      titulo={originalKey === "noticias" ? (texts.noticias?.title ?? "Notícias") : titulo}
      descricao={descricao}
      texts={texts}
      githubPath="src/pages/[lang]/[...slug].astro"
    >
      <Breadcrumbs lang={currentLang} slugArray={slugArray} texts={texts} />

      {(() => {
        switch (originalKey) {
          case "institucional/equipe":
            return <EquipeSection equipe={equipe} texts={texts} />;
          case "institucional/sobre":
            return <SobreSection blocos={sobre} />;
          case "institucional/documentos":
            return <DocumentosSection documentos={documentos} lang={currentLang} />;
          case "noticias":
            return <NoticiasListPage lang={currentLang} />;

          // Iniciativas
          case "iniciativas/cafe-com-ciencia":
            return <CafeComCienciaSection cafe={cafe} lang={currentLang} />;
          case "iniciativas/publicacoes":
          case "publicacao":
            return <PublicationListPage lang={currentLang} />;
          case "iniciativas/material-de-apoio":
            return <IniciativasMaterialApoioSection texts={texts} />;
          case "iniciativas/oficinas":
            return <IniciativasOficinasSection texts={texts} />;
          case "iniciativas/projetos":
            return <IniciativasProjetosSection texts={texts} />;
          case "iniciativas/projetos-de-pesquisa":
            return <IniciativasProjetosDePesquisaSection texts={texts} projetos={iniciativas.projetosLista} iniciativas={iniciativas}/>;
          case "iniciativas/projetos-de-dados":
            return <IniciativasProjetosDeDadosSection texts={texts} />;
          case "iniciativas/parcerias":
            return <IniciativasParceiriasSection texts={texts} />;
          case "iniciativas/solucoes-tecnologicas":
            return <IniciativasSolucoesTecnologicasSection texts={texts} />;

          default:
            return (
              <>
                <h1 class="text-3xl font-bold mb-4">404 - {texts.notFound}</h1>
                <p class="mb-4">
                  {texts.pageNotFound ?? "Desculpe, não encontramos a página"}:{" "}
                  <strong>{slugPath}</strong>
                </p>
                <p>
                  Idioma: <strong>{currentLang}</strong>
                </p>
              </>
            );
        }
      })()}
    </BaseLayout>
  )
}
