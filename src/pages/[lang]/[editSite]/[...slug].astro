---
export const prerender = true;

import { getCollection, render } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import routeTranslations from '../../../i18n/routeTranslations';
import type { SupportedLang } from '../../../types/lang';
import { buildEditarSiteSidebar } from '../../../utils/editarSiteSidebar';
import { selectDocsHomeEntry } from '../../../utils/docsHome';
import Notice from '../../../components/atividades/Notice.astro';
import Card from '../../../components/atividades/Card.astro';
import CardGrid from '../../../components/atividades/CardGrid.astro';
import LinkCard from '../../../components/atividades/LinkCard.astro';
import Steps from '../../../components/atividades/Steps.astro';

import DocsMdxPage from '../../../components/docs/DocsMdxPage.astro';

function getEditSiteBasePath(lang: SupportedLang): string {
  return `/${routeTranslations['editar-site'][lang]}`;
}

export async function getStaticPaths() {
  const langs: SupportedLang[] = ['pt', 'en', 'es'];
  const entries = await getCollection('editarSite');
  const homeEntry = selectDocsHomeEntry(entries);

  return langs.flatMap((lang) => {
    const paths = entries.map((entry) => ({
      params: {
        lang,
        editSite: routeTranslations['editar-site'][lang],
        slug: entry.slug,
      },
      props: { entry, homeSlug: homeEntry?.slug },
    }));

    if (!homeEntry) {
      return paths;
    }

    return [
      ...paths,
      {
        params: {
          lang,
          editSite: routeTranslations['editar-site'][lang],
          slug: undefined,
        },
        props: { entry: homeEntry, homeSlug: homeEntry.slug },
      },
    ];
  });
}

const lang = (Astro.params.lang ?? 'pt') as SupportedLang;
const expectedEditSite = routeTranslations['editar-site'][lang];

if (Astro.params.editSite !== expectedEditSite) {
  return Astro.redirect(`/${lang}/${expectedEditSite}`, 302);
}

// eslint-disable-next-line @typescript-eslint/no-explicit-any
const { entry, homeSlug } = Astro.props as { entry: any; homeSlug?: string };

if (homeSlug && Astro.params.slug === homeSlug) {
  return Astro.redirect(`/${lang}/${expectedEditSite}`, 301);
}

const { Content, headings } = await render(entry);
const currentPath = Astro.url.pathname;
const allEntries = await getCollection('editarSite');
const docsBasePath = getEditSiteBasePath(lang);
const sidebar = buildEditarSiteSidebar(allEntries, docsBasePath);
const localizedBasePath = `/${lang}${docsBasePath}`;
---

<BaseLayout
  titulo={entry.data.title}
  descricao={entry.data.description}
  githubPath={`src/content/editarSite/${entry.id}`}
  lang={lang}
>
  <DocsMdxPage
    sidebar={sidebar}
    currentPath={currentPath}
    lang={lang}
    basePath={localizedBasePath}
    baseLabel="Editar site"
    headings={headings}
    sectionTitle="Editar site"
    sectionIcon="fa-pen-to-square"
    title={entry.data.title}
    description={entry.data.description}
  >
    <Fragment slot="content">
      <Content components={{ Notice, Card, CardGrid, LinkCard, Steps }} />
    </Fragment>
  </DocsMdxPage>
</BaseLayout>
