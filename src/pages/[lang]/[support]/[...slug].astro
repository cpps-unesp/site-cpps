---
export const prerender = true;

import { getCollection, render } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import routeTranslations from '../../../i18n/routeTranslations';
import type { SupportedLang } from '../../../types/lang';
import { buildAtendimentoSidebar } from '../../../utils/atendimentoSidebar';
import { filterVisibleDocsEntries } from '../../../utils/docsVisibility';
import { selectDocsHomeEntry } from '../../../utils/docsHome';
import Notice from '../../../components/atividades/Notice.astro';
import Card from '../../../components/atividades/Card.astro';
import CardGrid from '../../../components/atividades/CardGrid.astro';
import LinkCard from '../../../components/atividades/LinkCard.astro';
import Steps from '../../../components/atividades/Steps.astro';
import DocsMdxPage from '../../../components/docs/DocsMdxPage.astro';

function getSupportBasePath(lang: SupportedLang): string {
  return `/${routeTranslations.atendimento[lang]}`;
}

export async function getStaticPaths() {
  const langs: SupportedLang[] = ['pt', 'en', 'es'];
  const entries = filterVisibleDocsEntries(await getCollection('atendimento'));
  const homeEntry = selectDocsHomeEntry(entries);

  return langs.flatMap((lang) => {
    const paths = entries.map((entry) => ({
      params: {
        lang,
        support: routeTranslations.atendimento[lang],
        slug: entry.slug,
      },
      props: { entry, homeSlug: homeEntry?.slug },
    }));

    if (!homeEntry) {
      return paths;
    }

    return [
      ...paths,
      {
        params: {
          lang,
          support: routeTranslations.atendimento[lang],
          slug: undefined,
        },
        props: { entry: homeEntry, homeSlug: homeEntry.slug },
      },
    ];
  });
}

const lang = (Astro.params.lang ?? 'pt') as SupportedLang;
const expectedSupport = routeTranslations.atendimento[lang];

if (Astro.params.support !== expectedSupport) {
  return Astro.redirect(`/${lang}/${expectedSupport}`, 302);
}

// eslint-disable-next-line @typescript-eslint/no-explicit-any
const { entry, homeSlug } = Astro.props as { entry: any; homeSlug?: string };

if (homeSlug && Astro.params.slug === homeSlug) {
  return Astro.redirect(`/${lang}/${expectedSupport}`, 301);
}

const { Content, headings } = await render(entry);
const currentPath = Astro.url.pathname;
const allEntries = filterVisibleDocsEntries(await getCollection('atendimento'));
const docsBasePath = getSupportBasePath(lang);
const sidebar = buildAtendimentoSidebar(allEntries, docsBasePath);
const localizedBasePath = `/${lang}${docsBasePath}`;
---

<BaseLayout
  titulo={entry.data.title}
  descricao={entry.data.description}
  githubPath={`src/content/atendimento/${entry.id}`}
  lang={lang}
>
  <DocsMdxPage
    sidebar={sidebar}
    currentPath={currentPath}
    lang={lang}
    basePath={localizedBasePath}
    baseLabel="Atendimento"
    headings={headings}
    sectionTitle="Atendimento"
    sectionIcon="fa-headset"
    title={entry.data.title}
    description={entry.data.description}
  >
    <Fragment slot="content">
      <Content components={{ Notice, Card, CardGrid, LinkCard, Steps }} />
    </Fragment>
  </DocsMdxPage>
</BaseLayout>
