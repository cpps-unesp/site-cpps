---
export const prerender = true;

import { getCollection, render } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import routeTranslations from '../../../i18n/routeTranslations';
import type { SupportedLang } from '../../../types/lang';
import { buildAtendimentoSidebar } from '../../../utils/atendimentoSidebar';
import Notice from '../../../components/atividades/Notice.astro';
import Card from '../../../components/atividades/Card.astro';
import CardGrid from '../../../components/atividades/CardGrid.astro';
import LinkCard from '../../../components/atividades/LinkCard.astro';
import Steps from '../../../components/atividades/Steps.astro';
import DocsMdxPage from '../../../components/docs/DocsMdxPage.astro';

function getSupportBasePath(lang: SupportedLang): string {
  return `/${routeTranslations.atendimento[lang]}`;
}

export async function getStaticPaths() {
  const langs: SupportedLang[] = ['pt', 'en', 'es'];
  const entries = await getCollection('atendimento');

  return langs.flatMap((lang) => {
    return entries.map((entry) => ({
      params: {
        lang,
        support: routeTranslations.atendimento[lang],
        slug: entry.slug === 'index' ? undefined : entry.slug,
      },
      props: { entry },
    }));
  });
}

const lang = (Astro.params.lang ?? 'pt') as SupportedLang;
const expectedSupport = routeTranslations.atendimento[lang];

if (Astro.params.support !== expectedSupport) {
  return Astro.redirect(`/${lang}/${expectedSupport}`, 302);
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);
const currentPath = Astro.url.pathname;
const allEntries = await getCollection('atendimento');
const docsBasePath = getSupportBasePath(lang);
const sidebar = buildAtendimentoSidebar(allEntries, docsBasePath);
const localizedBasePath = `/${lang}${docsBasePath}`;
---

<BaseLayout
  titulo={entry.data.title}
  descricao={entry.data.description}
  githubPath={`src/content/atendimento/${entry.id}`}
  lang={lang}
>
  <DocsMdxPage
    sidebar={sidebar}
    currentPath={currentPath}
    lang={lang}
    basePath={localizedBasePath}
    baseLabel="Atendimento"
    headings={headings}
    sectionTitle="Atendimento"
    sectionIcon="fa-headset"
    title={entry.data.title}
    description={entry.data.description}
  >
    <Fragment slot="content">
      <Content components={{ Notice, Card, CardGrid, LinkCard, Steps }} />
    </Fragment>
  </DocsMdxPage>
</BaseLayout>
