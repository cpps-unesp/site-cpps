---
export const prerender = true;

import { getCollection, render } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import routeTranslations from '../../../i18n/routeTranslations';
import type { SupportedLang } from '../../../types/lang';
import { buildAtendimentoSidebar } from '../../../utils/atendimentoSidebar';

import Notice from '../../../components/atividades/Notice.astro';
import Card from '../../../components/atividades/Card.astro';
import CardGrid from '../../../components/atividades/CardGrid.astro';
import LinkCard from '../../../components/atividades/LinkCard.astro';
import Steps from '../../../components/atividades/Steps.astro';

import DocsSidebar from '../../../components/docs/Sidebar.astro';
import TableOfContents from '../../../components/docs/TableOfContents.astro';
import Breadcrumbs from '../../../components/docs/Breadcrumbs.astro';
import Pagination from '../../../components/docs/Pagination.astro';

function getSupportBasePath(lang: SupportedLang): string {
  return `/${routeTranslations.atendimento[lang]}`;
}

export async function getStaticPaths() {
  const langs: SupportedLang[] = ['pt', 'en', 'es'];
  const entries = await getCollection('atendimento');

  return langs.flatMap((lang) => {
    return entries.map((entry) => ({
      params: {
        lang,
        support: routeTranslations.atendimento[lang],
        slug: entry.slug === 'index' ? undefined : entry.slug,
      },
      props: { entry },
    }));
  });
}

const lang = (Astro.params.lang ?? 'pt') as SupportedLang;
const expectedSupport = routeTranslations.atendimento[lang];

if (Astro.params.support !== expectedSupport) {
  return Astro.redirect(`/${lang}/${expectedSupport}`, 302);
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);
const currentPath = Astro.url.pathname;
const allEntries = await getCollection('atendimento');
const docsBasePath = getSupportBasePath(lang);
const sidebar = buildAtendimentoSidebar(allEntries, docsBasePath);
const localizedBasePath = `/${lang}${docsBasePath}`;
---

<BaseLayout
  titulo={entry.data.title}
  descricao={entry.data.description}
  githubPath={`src/content/atendimento/${entry.id}`}
  lang={lang}
>
  <div class="mx-auto max-w-screen-2xl px-4 pt-2 pb-12 md:px-8 md:pt-4 lg:pt-8">
    <div
      class="border-base-300 bg-base-100/80 sticky top-20 z-30 mb-4 flex items-center gap-2 border-b pb-3 backdrop-blur-md lg:hidden"
    >
      <button id="mobile-menu-left-trigger" class="btn btn-ghost btn-sm flex items-center gap-2">
        <i class="fa-solid fa-bars"></i>
        <span class="text-sm font-medium">Menu</span>
      </button>
      <div class="flex-1"></div>
      <button id="mobile-menu-right-trigger" class="btn btn-ghost btn-sm flex items-center gap-2">
        <span class="text-sm font-medium">Nesta pagina</span>
        <i class="fa-solid fa-list"></i>
      </button>
    </div>

    <div class="relative flex flex-col gap-8 lg:flex-row lg:gap-12" id="docs-container">
      <div
        id="mobile-backdrop"
        class="fixed inset-0 z-40 hidden bg-black/50 opacity-0 transition-opacity duration-300 lg:hidden"
      >
      </div>

      <aside
        id="left-sidebar"
        class="bg-base-100 fixed inset-y-0 left-0 z-50 w-full flex-shrink-0 -translate-x-full transform overflow-hidden p-4 shadow-2xl transition-all duration-300 lg:static lg:w-72 lg:translate-x-0 lg:bg-transparent lg:p-0 lg:shadow-none"
      >
        <div
          class="scrollbar-thin scrollbar-thumb-base-300 flex h-full flex-col lg:sticky lg:top-24 lg:h-auto lg:max-h-[calc(100vh-7rem)] lg:overflow-y-auto lg:pr-4"
        >
          <div class="mb-6 flex items-center justify-between lg:mb-6">
            <h3 class="text-primary flex items-center gap-2 text-lg font-bold">
              <i class="fa-solid fa-headset text-sm"></i>
              Atendimento
            </h3>
            <button id="mobile-close-left" class="btn btn-ghost btn-sm btn-circle lg:hidden">
              <i class="fa-solid fa-xmark"></i>
            </button>
            <button
              id="toggle-left"
              class="btn btn-ghost btn-xs hidden opacity-50 hover:opacity-100 lg:flex"
              title="Encolher menu"
            >
              <i class="fa-solid fa-angles-left"></i>
            </button>
          </div>
          <div class="flex-1 overflow-y-auto lg:overflow-visible">
            <DocsSidebar items={sidebar} currentPath={currentPath} lang={lang} />
          </div>
        </div>
      </aside>

      <button
        id="expand-left"
        class="bg-base-200 border-base-300 hover:bg-primary group fixed top-1/2 left-0 z-40 hidden -translate-y-1/2 rounded-r-xl border border-l-0 p-2 shadow-lg transition-all duration-300 hover:text-white"
        title="Expandir menu"
      >
        <i class="fa-solid fa-angles-right transition-transform group-hover:translate-x-1"></i>
      </button>

      <div class="min-w-0 flex-1 transition-all duration-300">
        <div class="relative mx-auto max-w-4xl">
          <Breadcrumbs
            currentPath={currentPath}
            basePath={localizedBasePath}
            baseLabel="Atendimento"
          />

          <article class="prose prose-lg dark:prose-invert max-w-none">
            <header class="not-prose mb-12">
              <h1 class="titulo mb-4 font-black">{entry.data.title}</h1>
              {
                entry.data.description && (
                  <p class="subtitulo text-base-content/70 border-primary/20 border-l-4 pl-6 leading-relaxed italic">
                    {entry.data.description}
                  </p>
                )
              }
              <div class="divider mt-8"></div>
            </header>

            <Content components={{ Notice, Card, CardGrid, LinkCard, Steps }} />
          </article>

          <Pagination currentPath={currentPath} lang={lang} items={sidebar} />
        </div>
      </div>

      <aside
        id="right-sidebar"
        class="bg-base-100 fixed inset-y-0 right-0 z-50 hidden w-64 flex-shrink-0 translate-x-full transform overflow-hidden p-4 shadow-2xl transition-all duration-300 xl:static xl:block xl:translate-x-0 xl:bg-transparent xl:p-0 xl:shadow-none"
      >
        <div class="flex h-full flex-col xl:sticky xl:top-24 xl:h-auto">
          <div class="mb-4 flex items-center justify-between xl:mb-4">
            <h3 class="text-base-content/40 text-xs font-bold tracking-widest uppercase">
              Nesta pagina
            </h3>
            <button id="mobile-close-right" class="btn btn-ghost btn-sm btn-circle xl:hidden">
              <i class="fa-solid fa-xmark"></i>
            </button>
            <button
              id="toggle-right"
              class="btn btn-ghost btn-xs hidden opacity-50 hover:opacity-100 xl:flex"
              title="Encolher indice"
            >
              <i class="fa-solid fa-angles-right"></i>
            </button>
          </div>
          <div class="flex-1 overflow-y-auto xl:overflow-visible">
            <TableOfContents headings={headings} />
          </div>
        </div>
      </aside>

      <button
        id="expand-right"
        class="bg-base-200 border-base-300 hover:bg-primary group fixed top-1/2 right-0 z-40 hidden -translate-y-1/2 rounded-l-xl border border-r-0 p-2 shadow-lg transition-all duration-300 hover:text-white"
        title="Expandir indice"
      >
        <i class="fa-solid fa-angles-left transition-transform group-hover:-translate-x-1"></i>
      </button>
    </div>
  </div>
</BaseLayout>

<script is:inline>
  const leftSidebar = document.getElementById('left-sidebar');
  const rightSidebar = document.getElementById('right-sidebar');
  const toggleLeft = document.getElementById('toggle-left');
  const toggleRight = document.getElementById('toggle-right');
  const expandLeft = document.getElementById('expand-left');
  const expandRight = document.getElementById('expand-right');
  const mobileMenuLeftTrigger = document.getElementById('mobile-menu-left-trigger');
  const mobileMenuRightTrigger = document.getElementById('mobile-menu-right-trigger');
  const mobileCloseLeft = document.getElementById('mobile-close-left');
  const mobileCloseRight = document.getElementById('mobile-close-right');
  const mobileBackdrop = document.getElementById('mobile-backdrop');

  function openLeftDrawer() {
    leftSidebar.classList.remove('-translate-x-full');
    leftSidebar.classList.add('translate-x-0');
    mobileBackdrop.classList.remove('hidden');
    void mobileBackdrop.offsetWidth;
    mobileBackdrop.classList.remove('opacity-0');
    document.body.style.overflow = 'hidden';
  }

  function closeLeftDrawer() {
    leftSidebar.classList.add('-translate-x-full');
    leftSidebar.classList.remove('translate-x-0');
    mobileBackdrop.classList.add('opacity-0');
    setTimeout(() => {
      mobileBackdrop.classList.add('hidden');
    }, 300);
    document.body.style.overflow = '';
  }

  function openRightDrawer() {
    rightSidebar.classList.remove('hidden');
    void rightSidebar.offsetWidth;
    rightSidebar.classList.remove('translate-x-full');
    rightSidebar.classList.add('translate-x-0');
    mobileBackdrop.classList.remove('hidden');
    void mobileBackdrop.offsetWidth;
    mobileBackdrop.classList.remove('opacity-0');
    document.body.style.overflow = 'hidden';
  }

  function closeRightDrawer() {
    rightSidebar.classList.add('translate-x-full');
    rightSidebar.classList.remove('translate-x-0');
    mobileBackdrop.classList.add('opacity-0');
    setTimeout(() => {
      mobileBackdrop.classList.add('hidden');
    }, 300);
    document.body.style.overflow = '';
  }

  mobileMenuLeftTrigger?.addEventListener('click', openLeftDrawer);
  mobileCloseLeft?.addEventListener('click', closeLeftDrawer);
  mobileMenuRightTrigger?.addEventListener('click', openRightDrawer);
  mobileCloseRight?.addEventListener('click', closeRightDrawer);
  mobileBackdrop?.addEventListener('click', () => {
    closeLeftDrawer();
    closeRightDrawer();
  });

  toggleLeft?.addEventListener('click', () => {
    leftSidebar.classList.add('lg:w-12');
    leftSidebar.classList.remove('lg:w-72');
    expandLeft.classList.remove('hidden');
  });

  expandLeft?.addEventListener('click', () => {
    leftSidebar.classList.add('lg:w-72');
    leftSidebar.classList.remove('lg:w-12');
    expandLeft.classList.add('hidden');
  });

  toggleRight?.addEventListener('click', () => {
    rightSidebar.classList.add('xl:w-10');
    rightSidebar.classList.remove('xl:w-64');
    expandRight.classList.remove('hidden');
  });

  expandRight?.addEventListener('click', () => {
    rightSidebar.classList.add('xl:w-64');
    rightSidebar.classList.remove('xl:w-10');
    expandRight.classList.add('hidden');
  });
</script>
