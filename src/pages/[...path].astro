---
// Esta página catch-all lida com rotas sem idioma e redireciona para a versão correta
// Se a URL já tem idioma (ex: /pt/pagina-inexistente), reescreve para a página 404

export const prerender = false; // Precisa ser SSR para acessar headers/cookies

const SUPPORTED_LANGS = ['pt', 'en', 'es'] as const;
type Lang = typeof SUPPORTED_LANGS[number];

const path = Astro.params.path ?? '';
const pathSegments = path.split('/');
const firstSegment = pathSegments[0];

// Se a URL já começa com um idioma válido, significa que a página não existe
// Nesse caso, reescreve para a página 404
if (SUPPORTED_LANGS.includes(firstSegment as Lang)) {
  return Astro.rewrite('/404');
}

/**
 * Faz parsing do header Accept-Language e retorna o idioma preferido
 */
function parseAcceptLanguage(header: string): Lang {
  if (!header) return 'pt';
  
  const languages = header.split(',').map(part => {
    const [lang, qPart] = part.trim().split(';');
    const q = qPart ? parseFloat(qPart.replace('q=', '')) : 1.0;
    const langCode = lang.split('-')[0].toLowerCase();
    return { lang: langCode, q };
  });
  
  languages.sort((a, b) => b.q - a.q);
  
  for (const { lang } of languages) {
    if (lang === 'pt' || lang === 'en' || lang === 'es') {
      return lang as Lang;
    }
  }
  
  return 'pt';
}

// Determina idioma preferido
let lang: Lang = 'pt';

const cookieLang = Astro.cookies.get('lang')?.value;
if (cookieLang && SUPPORTED_LANGS.includes(cookieLang as Lang)) {
  lang = cookieLang as Lang;
} else {
  const acceptLang = Astro.request.headers.get('accept-language') ?? '';
  lang = parseAcceptLanguage(acceptLang);
}

// Redireciona para URL com idioma
const newPath = `/${lang}/${path}`;
return Astro.redirect(newPath, 301);
---
