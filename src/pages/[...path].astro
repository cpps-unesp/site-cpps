---
// Esta página catch-all lida com rotas sem idioma e redireciona para a versão correta
// O middleware cuida da lógica de detecção de idioma

export const prerender = false; // Precisa ser SSR para acessar headers/cookies

const SUPPORTED_LANGS = ['pt', 'en', 'es'] as const;
type Lang = typeof SUPPORTED_LANGS[number];

const path = Astro.params.path ?? '';

// Determina idioma preferido
let lang: Lang = 'pt'; // fallback

// Primeiro verifica cookie
const cookieLang = Astro.cookies.get('lang')?.value;
if (cookieLang && SUPPORTED_LANGS.includes(cookieLang as Lang)) {
  lang = cookieLang as Lang;
} else {
  // Senão, detecta do navegador
  const acceptLang = Astro.request.headers.get('accept-language') ?? '';
  
  if (acceptLang.match(/^es\b|,\s*es\b/i)) {
    lang = 'es';
  } else if (acceptLang.match(/^en\b|,\s*en\b/i)) {
    lang = 'en';
  }
}

// Redireciona para URL com idioma
const newPath = `/${lang}/${path}`;
return Astro.redirect(newPath, 301);
---
