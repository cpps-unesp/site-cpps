---
import routeTranslations from '../i18n/routeTranslations';
import { getTranslatedPath } from '../utils/getTranslatedPath';
import type { SupportedLang } from '../i18n/routeTranslations';

interface Props {
  availableLangs: string[];
  currentLang: string;
  texts: any;
}

const { availableLangs, currentLang, texts } = Astro.props;

const langNames: Record<string, string> = {
  pt: "Português",
  en: "English",
  es: "Español",
};

const warningText = texts.languageUnavailable || (
  currentLang === 'en' ? 'CONTENT NOT AVAILABLE IN ENGLISH' :
  (currentLang === 'es' ? 'CONTENIDO NO DISPONIBLE EN ESPAÑOL' : 'CONTEÚDO NÃO DISPONÍVEL EM PORTUGUÊS')
);

const availableInText = currentLang === 'en' ? 'This page is available in:' :
  (currentLang === 'es' ? 'Esta página está disponible en:' : 'Esta página está disponível em:');

const sourceLang = (['pt', 'en', 'es'].includes(currentLang) ? currentLang : 'pt') as SupportedLang;
const currentPath = Astro.url.pathname.split('/').filter(Boolean).slice(1).join('/');

function getRouteMatch(path: string, lang: SupportedLang) {
  const keys = Object.keys(routeTranslations) as Array<keyof typeof routeTranslations>;
  let bestMatch:
    | { key: keyof typeof routeTranslations; prefix: string; remainder: string }
    | null = null;

  for (const key of keys) {
    const prefix = routeTranslations[key][lang];
    if (path === prefix || path.startsWith(`${prefix}/`)) {
      const remainder = path.slice(prefix.length).replace(/^\//, '');
      if (!bestMatch || prefix.length > bestMatch.prefix.length) {
        bestMatch = { key, prefix, remainder };
      }
    }
  }

  return bestMatch;
}

function getPathForLanguage(targetLang: SupportedLang): string {
  const match = getRouteMatch(currentPath, sourceLang);
  if (!match) return currentPath;

  const translatedPrefix = getTranslatedPath(match.key, targetLang);
  return `${translatedPrefix}${match.remainder ? `/${match.remainder}` : ''}`;
}
---

<div class="max-w-4xl mx-auto mt-8 px-4">
  <div class="alert alert-warning shadow-lg border-l-8 border-warning flex flex-col md:flex-row items-start md:items-center gap-4 py-6">
    <div class="flex items-center gap-3">
        <i class="fa-solid fa-language text-3xl opacity-80"></i>
        <div>
            <h3 class="font-bold text-xs uppercase tracking-widest opacity-70 mb-1">{warningText}</h3>
            <p class="text-sm font-medium">{availableInText}</p>
        </div>
    </div>
    <div class="flex flex-wrap gap-2 md:ml-auto">
      {availableLangs.map((lang) => (
        <a
          href={`/${lang}/${getPathForLanguage(lang as SupportedLang)}`.replace(/\/+/g, '/')}
          class="btn btn-xs btn-outline hover:btn-primary transition-all px-4"
        >
          {langNames[lang] || lang.toUpperCase()}
        </a>
      ))}
    </div>
  </div>
</div>
