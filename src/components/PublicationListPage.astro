---
import PublicationCard from './PublicationCard.astro';
import PublicationFeatured from './PublicationFeatured.astro';
import { getCollection } from 'astro:content';
import { getTranslations } from '../utils/i18n';
import type { SupportedLang } from '../types/lang';

interface Props {
  lang: SupportedLang;
}

const { lang } = Astro.props;
const locale = getTranslations(lang);

const allPublications = await getCollection('publicacoes');
const langPublications = allPublications
  .filter(p => p.data.lang === lang)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const featuredPublication = langPublications.find(p => p.data.featured) || langPublications[0];
const regularPublications = langPublications.filter(p => p.id !== featuredPublication?.id);

const publicationTypes = [
  'artigo', 'analise', 'material-didatico', 'texto-curto', 'texto-longo'
];
---

<section class="container mx-auto px-4 py-16">
    <header class="mb-12">
      <h1 class="text-5xl font-black text-gray-900 mb-4 italic uppercase tracking-tighter">
        {locale.texts.header.publicacoes}
      </h1>
      <div class="w-24 h-2 bg-primary"></div>
    </header>

    {featuredPublication && (
      <div id="featured-section">
         <PublicationFeatured publication={featuredPublication} lang={lang} />
      </div>
    )}

    <!-- Filtros -->
    <section class="bg-white border border-gray-200 rounded-xl p-6 mb-12 shadow-sm">
      <div class="grid md:grid-cols-3 gap-6">
        <!-- Busca -->
        <div>
          <label class="block text-xs font-black uppercase text-gray-400 mb-2 tracking-widest">{locale.publicacoes.search}</label>
          <div class="relative">
            <input
              type="text"
              id="search-input"
              placeholder={locale.publicacoes.search}
              class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all"
            />
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
        </div>

        <!-- Tipo -->
        <div>
          <label class="block text-xs font-black uppercase text-gray-400 mb-2 tracking-widest">{locale.publicacoes.filterByType}</label>
          <select id="type-filter" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all appearance-none bg-no-repeat bg-[right_1rem_center] bg-[length:1em_1em]" style="background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666666%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');">
            <option value="all">{locale.publicacoes.allTypes}</option>
            {publicationTypes.map(type => (
              <option value={type}>{locale.publicacoes.types[type]}</option>
            ))}
          </select>
        </div>

        <!-- Autor -->
        <div>
          <label class="block text-xs font-black uppercase text-gray-400 mb-2 tracking-widest">{locale.publicacoes.filterByAuthor}</label>
          <input
            type="text"
            id="author-input"
            placeholder={locale.publicacoes.authors}
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all"
          />
        </div>
      </div>
    </section>

    <!-- Lista -->
    <div id="publications-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
      {regularPublications.map(pub => (
        <PublicationCard publication={pub} lang={lang} />
      ))}
    </div>

    <!-- Mensagem de Sem Resultados -->
    <div id="no-results" class="hidden text-center py-20">
      <p class="text-xl text-gray-400 font-bold italic">{locale.publicacoes.noResults}</p>
    </div>
  </section>

<script>
  function setupFilters() {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const typeFilter = document.getElementById('type-filter') as HTMLSelectElement;
    const authorInput = document.getElementById('author-input') as HTMLInputElement;
    const cards = document.querySelectorAll('.publication-card');
    const featuredSection = document.getElementById('featured-section');
    const noResults = document.getElementById('no-results');

    const urlParams = new URLSearchParams(window.location.search);
    const tagParam = urlParams.get('tag');
    const authorParam = urlParams.get('author');

    if (tagParam && searchInput) {
      searchInput.value = tagParam;
    }
    if (authorParam && authorInput) {
      authorInput.value = authorParam;
    }

    function filter() {
      const searchValue = searchInput.value.toLowerCase();
      const typeValue = typeFilter.value;
      const authorValue = authorInput.value.toLowerCase();

      let visibleCount = 0;

      cards.forEach(card => {
        const element = card as HTMLElement;
        const title = element.dataset.title || '';
        const type = element.dataset.type || '';
        const authors = element.dataset.authors || '';

        const matchesSearch = title.includes(searchValue);
        const matchesType = typeValue === 'all' || type === typeValue;
        const matchesAuthor = authors.includes(authorValue);

        if (matchesSearch && matchesType && matchesAuthor) {
          element.style.display = 'flex';
          visibleCount++;
        } else {
          element.style.display = 'none';
        }
      });

      if (searchValue || typeValue !== 'all' || authorValue) {
        if (featuredSection) featuredSection.style.display = 'none';
      } else {
        if (featuredSection) featuredSection.style.display = 'block';
      }

      if (noResults) {
        if (visibleCount === 0) {
          noResults.classList.remove('hidden');
        } else {
          noResults.classList.add('hidden');
        }
      }
    }

    searchInput?.addEventListener('input', filter);
    typeFilter?.addEventListener('change', filter);
    authorInput?.addEventListener('input', filter);

    if (tagParam || authorParam) {
      filter();
    }
  }

  setupFilters();
  document.addEventListener('astro:after-swap', setupFilters);
</script>
