---
import PublicationCard from './PublicationCard.astro';
import PublicationFeatured from './PublicationFeatured.astro';
import { getCollection } from 'astro:content';
import { getTranslations } from '../utils/i18n';
import type { SupportedLang } from '../types/lang';

interface Props {
  lang: SupportedLang;
}

const { lang } = Astro.props;
const locale = getTranslations(lang);

const allPublications = await getCollection('publicacoes');
const langPublications = allPublications
  .filter((p) => p.data.lang === lang)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const featuredPublication = langPublications.find((p) => p.data.featured) || langPublications[0];
const regularPublications = langPublications.filter((p) => p.id !== featuredPublication?.id);

const publicationTypes = ['artigo', 'analise', 'material-didatico', 'texto-curto', 'texto-longo'];
---

<section class="mx-auto max-w-screen-xl px-4 py-16 md:px-8">
  <header class="mb-12 text-center md:text-left">
    <h1 class="titulo text-primary mb-6 text-5xl sm:text-7xl">
      {locale.texts.header.publicacoes}
    </h1>
    <div class="bg-primary/20 mx-auto h-1.5 w-24 md:mx-0"></div>

    <div class="mt-8 flex flex-wrap items-center justify-center gap-3 md:justify-start">
      <a
        href={`/${lang}/publicacoes`}
        class="border-base-300 hover:border-primary hover:text-primary bg-base-100 rounded-full border px-4 py-2 text-[10px] font-bold tracking-widest uppercase shadow-sm transition-all"
      >
        {locale.publicacoes.allTypes}
      </a>
      {
        publicationTypes.map((type) => (
          <a
            href={`/${lang}/publicacoes?type=${encodeURIComponent(type)}`}
            class="border-base-300 hover:border-primary hover:text-primary bg-base-100 rounded-full border px-4 py-2 text-[10px] font-bold tracking-widest uppercase shadow-sm transition-all"
          >
            {locale.publicacoes.types[type]}
          </a>
        ))
      }
    </div>
  </header>

  {
    featuredPublication && (
      <div id="featured-section">
        <PublicationFeatured publication={featuredPublication} lang={lang} />
      </div>
    )
  }

  <!-- Filtros -->
  <section class="bg-base-200/50 border-base-300 mb-16 rounded-3xl border p-8 shadow-inner">
    <div class="grid gap-8 md:grid-cols-3">
      <!-- Busca -->
      <div>
        <label
          class="text-base-content/40 mb-3 block pl-1 text-[10px] font-black tracking-widest uppercase"
          >{locale.publicacoes.search}</label
        >
        <div class="relative">
          <input
            type="text"
            id="search-input"
            placeholder={locale.publicacoes.search}
            class="bg-base-100 border-base-300 focus:ring-primary/10 focus:border-primary w-full rounded-xl border py-3 pr-4 pl-12 shadow-sm transition-all outline-none focus:ring-4"
          />
          <i
            class="fa-solid fa-magnifying-glass text-base-content/30 absolute top-1/2 left-4 -translate-y-1/2"
          ></i>
        </div>
      </div>

      <!-- Tipo -->
      <div>
        <label
          class="text-base-content/40 mb-3 block pl-1 text-[10px] font-black tracking-widest uppercase"
          >{locale.publicacoes.filterByType}</label
        >
        <div class="relative">
          <select
            id="type-filter"
            class="bg-base-100 border-base-300 focus:ring-primary/10 focus:border-primary w-full cursor-pointer appearance-none rounded-xl border px-4 py-3 shadow-sm transition-all outline-none focus:ring-4"
          >
            <option value="all">{locale.publicacoes.allTypes}</option>
            {
              publicationTypes.map((type) => (
                <option value={type}>{locale.publicacoes.types[type]}</option>
              ))
            }
          </select>
          <i
            class="fa-solid fa-chevron-down text-base-content/30 pointer-events-none absolute top-1/2 right-4 -translate-y-1/2"
          ></i>
        </div>
      </div>

      <!-- Autor -->
      <div>
        <label
          class="text-base-content/40 mb-3 block pl-1 text-[10px] font-black tracking-widest uppercase"
          >{locale.publicacoes.filterByAuthor}</label
        >
        <div class="relative">
          <input
            type="text"
            id="author-input"
            placeholder={locale.publicacoes.authors}
            class="bg-base-100 border-base-300 focus:ring-primary/10 focus:border-primary w-full rounded-xl border py-3 pr-4 pl-12 shadow-sm transition-all outline-none focus:ring-4"
          />
          <i class="fa-solid fa-user text-base-content/30 absolute top-1/2 left-4 -translate-y-1/2"
          ></i>
        </div>
      </div>
    </div>
  </section>

  <!-- Lista -->
  <div id="publications-grid" class="grid gap-10 md:grid-cols-2 lg:grid-cols-3">
    {regularPublications.map((pub) => <PublicationCard publication={pub} lang={lang} />)}
  </div>

  <!-- Mensagem de Sem Resultados -->
  <div
    id="no-results"
    class="bg-base-200/30 border-base-300 hidden rounded-3xl border-2 border-dashed py-24 text-center"
  >
    <i class="fa-solid fa-file-circle-xmark text-base-content/20 mb-4 block text-5xl"></i>
    <p class="text-base-content/50 text-xl font-bold italic">{locale.publicacoes.noResults}</p>
  </div>
</section>

<script>
  function setupFilters() {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const typeFilter = document.getElementById('type-filter') as HTMLSelectElement;
    const authorInput = document.getElementById('author-input') as HTMLInputElement;
    const cards = document.querySelectorAll('.publication-card');
    const featuredSection = document.getElementById('featured-section');
    const noResults = document.getElementById('no-results');

    const urlParams = new URLSearchParams(window.location.search);
    const tagParam = urlParams.get('tag');
    const authorParam = urlParams.get('author');
    const typeParam = urlParams.get('type');

    if (tagParam && searchInput) {
      searchInput.value = tagParam;
    }
    if (authorParam && authorInput) {
      authorInput.value = authorParam;
    }
    if (typeParam && typeFilter) {
      const optionExists = Array.from(typeFilter.options).some(
        (option) => option.value === typeParam
      );
      if (optionExists) {
        typeFilter.value = typeParam;
      }
    }

    function filter() {
      const searchValue = searchInput.value.toLowerCase();
      const typeValue = typeFilter.value;
      const authorValue = authorInput.value.toLowerCase();

      let visibleCount = 0;

      cards.forEach((card) => {
        const element = card as HTMLElement;
        const title = element.dataset.title || '';
        const type = element.dataset.type || '';
        const authors = element.dataset.authors || '';

        const matchesSearch = title.includes(searchValue);
        const matchesType = typeValue === 'all' || type === typeValue;
        const matchesAuthor = authors.includes(authorValue);

        if (matchesSearch && matchesType && matchesAuthor) {
          element.style.display = 'flex';
          visibleCount++;
        } else {
          element.style.display = 'none';
        }
      });

      if (searchValue || typeValue !== 'all' || authorValue) {
        if (featuredSection) featuredSection.style.display = 'none';
      } else {
        if (featuredSection) featuredSection.style.display = 'block';
      }

      if (noResults) {
        if (visibleCount === 0) {
          noResults.classList.remove('hidden');
        } else {
          noResults.classList.add('hidden');
        }
      }
    }

    searchInput?.addEventListener('input', filter);
    typeFilter?.addEventListener('change', filter);
    authorInput?.addEventListener('input', filter);

    if (tagParam || authorParam || typeParam) {
      filter();
    }
  }

  setupFilters();
  document.addEventListener('astro:after-swap', setupFilters);
</script>
