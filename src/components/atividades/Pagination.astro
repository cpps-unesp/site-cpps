---
import { sidebar, type SidebarItem } from '../../config/atividades';

interface Props {
  currentPath: string;
  lang?: string;
}

const { currentPath, lang } = Astro.props;

function buildUrl(url?: string) {
  if (!url || url.startsWith('http')) return url;
  if (!lang) return url;
  if (url.startsWith(`/${lang}/`) || url === `/${lang}`) return url;
  if (url.startsWith('/')) return `/${lang}${url}`;
  return `/${lang}/${url}`;
}

// Função para achatar o sidebar para facilitar a navegação
function flattenSidebar(items: SidebarItem[]): { label: string; url: string }[] {
  return items.reduce(
    (acc, item) => {
      if (item.url) {
        acc.push({ label: item.label, url: item.url });
      }
      if (item.items) {
        acc.push(...flattenSidebar(item.items));
      }
      return acc;
    },
    [] as { label: string; url: string }[]
  );
}

const flatItems = flattenSidebar(sidebar);
const normalizedPath = currentPath.replace(/\/$/, '');
const normalizedPathWithoutLang = lang
  ? normalizedPath.replace(new RegExp(`^/${lang}`), '')
  : normalizedPath;
const currentIndex = flatItems.findIndex(
  (item) => item.url.replace(/\/$/, '') === normalizedPathWithoutLang
);

const prev = currentIndex > 0 ? flatItems[currentIndex - 1] : null;
const next = currentIndex < flatItems.length - 1 ? flatItems[currentIndex + 1] : null;
---

{
  (prev || next) && (
    <div class="border-base-300 mt-16 grid grid-cols-1 gap-4 border-t pt-8 sm:grid-cols-2">
      {prev ? (
        <a
          href={buildUrl(prev.url)}
          class="group border-base-300 hover:border-primary flex flex-col gap-2 rounded-xl border p-4 text-left transition-all"
        >
          <span class="text-base-content/50 group-hover:text-primary text-xs tracking-widest uppercase">
            Anterior
          </span>
          <span class="group-hover:text-primary text-lg font-bold transition-colors">
            ← {prev.label}
          </span>
        </a>
      ) : (
        <div />
      )}

      {next && (
        <a
          href={buildUrl(next.url)}
          class="group border-base-300 hover:border-primary flex flex-col gap-2 rounded-xl border p-4 text-right transition-all"
        >
          <span class="text-base-content/50 group-hover:text-primary text-xs tracking-widest uppercase">
            Próximo
          </span>
          <span class="group-hover:text-primary text-lg font-bold transition-colors">
            {next.label} →
          </span>
        </a>
      )}
    </div>
  )
}
