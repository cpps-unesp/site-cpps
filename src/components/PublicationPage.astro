---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getTranslations } from '../utils/i18n';
import type { SupportedLang } from '../types/lang';
import { getCollection, render } from 'astro:content';
import TranslationWarning from './TranslationWarning.astro';

interface Props {
  lang: SupportedLang;
  slug: string;
}

const { lang, slug } = Astro.props;
const locale = getTranslations(lang);

const allPublications = await getCollection('publicacoes');
const relatedPubs = allPublications.filter(p => p.slug === slug || p.id === slug || p.id === `${slug}.md` || p.id === `${slug}.mdx`);

const availableLangs = relatedPubs.map(p => p.data.lang);
const isTranslationMissing = relatedPubs.length > 0 && !availableLangs.includes(lang);

let publication = relatedPubs.find(p => p.data.lang === lang);

if (!publication && relatedPubs.length > 0) {
  publication = relatedPubs.find(p => p.data.lang === 'pt') || relatedPubs[0];
}

if (!publication) {
  return Astro.redirect(`/${lang}/404`);
}

const { data } = publication;
const { Content } = await render(publication);

const typeLabel = locale.publicacoes.types[data.type] || data.type;

const formattedDate = new Intl.DateTimeFormat(lang, {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
}).format(data.date);
---

<BaseLayout
  lang={lang}
  titulo={data.title}
  descricao={data.summary}
  texts={locale.texts}
  identidade={locale.identidade}
  githubPath={`src/content/publicacoes/${publication.id}`}
>
  {isTranslationMissing && (
    <TranslationWarning
      availableLangs={availableLangs}
      currentLang={lang}
      texts={locale.texts}
    />
  )}
  <article class="max-w-screen-xl mx-auto px-4 md:px-8 py-16">
    <header class="mb-16 border-b border-base-200 pb-12">
      <div class="flex items-center gap-4 mb-6">
        <a
          href={`/${lang}/publicacoes?type=${encodeURIComponent(data.type)}`}
          class="bg-primary/10 text-primary text-[10px] font-black uppercase tracking-widest px-3 py-1 rounded-full border border-primary/20 hover:bg-primary/20 transition-colors"
        >
          {typeLabel}
        </a>
        <span class="text-base-content/40 text-sm font-medium">{formattedDate}</span>
      </div>

      <h1 class="text-4xl md:text-6xl font-black text-base-content mb-8 leading-tight tracking-tight publication-title">
        {data.title}
      </h1>

      <div class="grid lg:grid-cols-12 gap-12">
        <div class="lg:col-span-8">
           <p class="text-xl md:text-2xl text-base-content/70 leading-relaxed font-medium italic mb-10 border-l-4 border-primary/20 pl-8">
            {data.summary}
          </p>

          <div class="flex flex-wrap gap-3 mb-8">
            <span class="text-[10px] font-black uppercase text-base-content/30 w-full mb-1 tracking-widest">{locale.publicacoes.keywords}</span>
            {data.tags.map((tag: string) => (
              <a
                href={`/${lang}/publicacoes?tag=${encodeURIComponent(tag)}`}
                class="bg-base-200 text-base-content/60 text-xs font-semibold px-3 py-1.5 rounded-lg hover:bg-primary hover:text-white transition-all shadow-sm"
              >
                #{tag}
              </a>
            ))}
          </div>
        </div>

        <div class="lg:col-span-4">
          <div class="bg-base-200/50 p-8 rounded-3xl h-fit border border-base-300 shadow-inner">
            <h3 class="text-[10px] font-black uppercase text-base-content/40 mb-5 tracking-widest pl-1">{locale.publicacoes.authors}</h3>
            <ul class="space-y-4">
              {data.authors.map((author: string) => (
                <li>
                  <a
                    href={`/${lang}/publicacoes?author=${encodeURIComponent(author)}`}
                    class="text-base font-bold text-base-content hover:text-primary hover:underline transition-colors flex items-center gap-2"
                  >
                    <i class="fa-solid fa-user text-xs opacity-30"></i>
                    {author}
                  </a>
                </li>
              ))}
            </ul>

            {data.pdf_url && (
              <div class="mt-10 pt-8 border-t border-base-300/50">
                <a href={data.pdf_url} target="_blank" class="btn btn-error btn-block gap-3 text-white font-black shadow-lg shadow-error/20">
                  <i class="fa-solid fa-file-pdf text-lg"></i>
                  {locale.publicacoes.downloadPdf}
                </a>
              </div>
            )}
          </div>
        </div>
      </div>
    </header>

    <div class="prose prose-lg max-w-none
      prose-headings:text-primary prose-headings:font-black prose-headings:tracking-tight
      prose-p:text-base-content/80 prose-p:leading-relaxed prose-p:text-justify
      prose-a:text-primary prose-a:font-bold hover:prose-a:underline
      prose-img:rounded-3xl prose-img:shadow-2xl">
      <Content />
    </div>
  </article>
</BaseLayout>

<style>
  .publication-title {
    font-family: 'Montserrat', sans-serif !important;
    text-transform: none !important;
  }
</style>
