---
import { getTranslatedPath } from '../utils/getTranslatedPath';
import type { SupportedLang } from '../i18n/routeTranslations';
import { getCollection } from 'astro:content';
import IconLang from '../icons/iconLang.astro';
import { getTranslations } from '../utils/i18n';
import { getRouteMatch } from '../utils/i18nRouteMatch';

const { lang = 'pt' } = Astro.props as { lang?: SupportedLang };

const languages: { code: SupportedLang; label: string }[] = [
  { code: 'pt', label: 'Português' },
  { code: 'en', label: 'English' },
  { code: 'es', label: 'Español' },
];

// eslint-disable-next-line @typescript-eslint/no-explicit-any
const translations: Record<SupportedLang, any> = {
  pt: getTranslations('pt'),
  en: getTranslations('en'),
  es: getTranslations('es'),
};

const pathParts = Astro.url.pathname.split('/').filter(Boolean);
const currentPath = pathParts.slice(1).join('/');

const routeMatch = getRouteMatch(currentPath, lang);

let membroBaseSlug: string | null = null;
let membrosPorIdioma: Record<SupportedLang, boolean> = {
  pt: false,
  en: false,
  es: false,
};

if (!routeMatch && currentPath) {
  const allMembros = await getCollection('membros');

  for (const membro of allMembros) {
    const fileName = membro.id.split('/').pop() ?? '';
    const baseSlug = fileName.replace(/\.(pt|en|es)\.mdx$/, '');
    const idioma = membro.data.lang;

    if (baseSlug === currentPath || membroBaseSlug === baseSlug) {
      membroBaseSlug = baseSlug;
      membrosPorIdioma[idioma] = true;
    }
  }
}
---

<!-- ✅ Dropdown de idiomas -->
<div class="dropdown dropdown-hover dropdown-end group w-full md:w-auto">
  <label
    tabindex="0"
    class="hover:text-primary text-base-content flex w-full cursor-pointer items-center gap-1 md:w-auto"
  >
    <IconLang class="text-base-content h-5 w-5" />

    <span class="text-sm font-normal">{lang.toUpperCase()}</span>

    <svg class="text-base-content ml-1 h-3 w-3 fill-current" viewBox="0 0 20 20">
      <path d="M5.25 7.75L10 12.5l4.75-4.75"></path>
    </svg>
  </label>

  <ul
    class="dropdown-content menu bg-base-100 text-base-content w-full -translate-y-2 scale-95 transform rounded-sm p-0 opacity-0 shadow transition duration-150 ease-out group-hover:scale-100 group-hover:opacity-100 md:w-40"
  >
    {
      languages.map((l) => {
        let href = `/${l.code}/`;
        let disabled = false;
        let labelExtra = '';

        if (routeMatch) {
          const translatedPrefix = getTranslatedPath(routeMatch.key, l.code);
          href = `/${l.code}/${translatedPrefix}${routeMatch.remainder ? `/${routeMatch.remainder}` : ''}`;
        } else if (membroBaseSlug) {
          href = `/${l.code}/${membroBaseSlug}`;
          if (!membrosPorIdioma[l.code]) {
            disabled = true;
            labelExtra = ` (${translations[l.code]?.texts?.languageUnavailable ?? 'Not available'})`;
          }
        } else if (currentPath) {
          href = `/${l.code}/${currentPath}`;
        }

        return (
          <li>
            <a
              href={disabled ? undefined : href}
              data-lang-switch={l.code}
              class={`hover:bg-base-200 ${disabled ? 'cursor-not-allowed opacity-50' : ''}`}
              aria-disabled={disabled}
            >
              {l.label}
              {labelExtra}
            </a>
          </li>
        );
      })
    }
  </ul>
</div>

<script>
  document.querySelectorAll('[data-lang-switch]').forEach((link) => {
    link.addEventListener('click', () => {
      const lang = (link as HTMLElement).dataset.langSwitch;
      if (lang) {
        document.cookie = `lang=${lang}; path=/; max-age=31536000; SameSite=Lax`;
      }
    });
  });
</script>
