---
import type { SidebarItem } from '../../config/docs';

interface Props {
  items: SidebarItem[];
  currentPath: string;
  level?: number;
}

const { items, currentPath, level = 0 } = Astro.props;

function isActive(url?: string) {
  if (!url) return false;
  const normalizedUrl = url.replace(/\/$/, "");
  const normalizedPath = currentPath.replace(/\/$/, "");
  return normalizedPath === normalizedUrl;
}

function hasActiveChild(item: SidebarItem): boolean {
  if (item.url && isActive(item.url)) return true;
  if (item.items) {
    return item.items.some(child => hasActiveChild(child));
  }
  return false;
}
---

<ul class={`space-y-1 ${level > 0 ? 'ml-4 border-l border-base-300 pl-4 mt-1' : ''}`}>
  {items.map((item) => (
    <li>
      {item.items && item.items.length > 0 ? (
        <details open={hasActiveChild(item) || !item.collapsed} class="group/details">
          <summary class="flex items-center justify-between py-1.5 px-2 rounded-lg cursor-pointer hover:bg-base-200 transition-colors list-none [&::-webkit-details-marker]:hidden">
            {item.url ? (
               <a
                href={item.url}
                class={`text-sm transition-colors hover:text-primary ${
                  isActive(item.url) ? 'text-primary font-bold active' : 'text-base-content/70'
                }`}
              >
                {item.label}
              </a>
            ) : (
              <span class={`text-sm font-semibold ${level === 0 ? 'uppercase tracking-wider text-base-content/40' : 'text-base-content/70'}`}>
                {item.label}
              </span>
            )}
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-50 group-open/details:rotate-180 transition-transform" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </summary>
          <div class="mt-1">
            <Astro.self items={item.items} currentPath={currentPath} level={level + 1} />
          </div>
        </details>
      ) : (
        item.url ? (
          <a
            href={item.url}
            class={`block py-1.5 px-2 rounded-lg text-sm transition-colors hover:bg-base-200 hover:text-primary ${
              isActive(item.url)
                ? 'bg-primary/10 text-primary font-bold active'
                : 'text-base-content/70'
            }`}
          >
            {item.label}
          </a>
        ) : (
          <span class={`block py-1.5 px-2 text-xs font-semibold uppercase tracking-wider text-base-content/40 ${level === 0 ? 'mt-4 first:mt-0' : ''}`}>
            {item.label}
          </span>
        )
      )}
    </li>
  ))}
</ul>

<style>
  /* Remove o marcador padr√£o do summary no Safari e outros */
  summary {
    display: flex;
  }
</style>
