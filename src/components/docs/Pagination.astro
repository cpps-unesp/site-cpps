---
import type { SidebarItem } from '../../types/docs';

interface Props {
  currentPath: string;
  items: SidebarItem[];
  lang?: string;
}

const { currentPath, items, lang } = Astro.props;

function buildUrl(url?: string) {
  if (!url || url.startsWith('http')) return url;
  if (!lang) return url;
  if (url.startsWith(`/${lang}/`) || url === `/${lang}`) return url;
  if (url.startsWith('/')) return `/${lang}${url}`;
  return `/${lang}/${url}`;
}

function flattenSidebar(sidebarItems: SidebarItem[]): { label: string; url: string }[] {
  return sidebarItems.reduce((acc, item) => {
    if (item.url && !item.url.startsWith('http')) {
      acc.push({ label: item.label, url: item.url });
    }
    if (item.items) {
      acc.push(...flattenSidebar(item.items));
    }
    return acc;
  }, [] as { label: string; url: string }[]);
}

const flatItems = flattenSidebar(items);
const normalizedPath = currentPath.replace(/\/$/, '');
const normalizedPathWithoutLang = lang
  ? normalizedPath.replace(new RegExp(`^/${lang}`), '')
  : normalizedPath;
const currentIndex = flatItems.findIndex((item) => item.url.replace(/\/$/, '') === normalizedPathWithoutLang);

const prev = currentIndex > 0 ? flatItems[currentIndex - 1] : null;
const next = currentIndex < flatItems.length - 1 ? flatItems[currentIndex + 1] : null;
---

{(prev || next) && (
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-16 pt-8 border-t border-base-300">
    {prev ? (
      <a href={buildUrl(prev.url)} class="group flex flex-col gap-2 p-4 rounded-xl border border-base-300 hover:border-primary transition-all text-left">
        <span class="text-xs text-base-content/50 uppercase tracking-widest group-hover:text-primary">Anterior</span>
        <span class="text-lg font-bold group-hover:text-primary transition-colors">← {prev.label}</span>
      </a>
    ) : <div></div>}

    {next && (
      <a href={buildUrl(next.url)} class="group flex flex-col gap-2 p-4 rounded-xl border border-base-300 hover:border-primary transition-all text-right">
        <span class="text-xs text-base-content/50 uppercase tracking-widest group-hover:text-primary">Proximo</span>
        <span class="text-lg font-bold group-hover:text-primary transition-colors">{next.label} →</span>
      </a>
    )}
  </div>
)}
